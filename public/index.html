<!-- Written by David Neuy
     Version 0.1.0 @ 03.12.2014
     This script was first published at: http://www.home-automation-community.com/
     You may republish it as is or publish a modified version only when you 
     provide a link to 'http://www.home-automation-community.com/'. 
-->
<html>
<head>
  <title>Raspberry Pi Home Weather Chart</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.15-beta/nv.d3.min.js"></script>
  <link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/nvd3/1.1.15-beta/nv.d3.css">
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css">
  <style>
    body {
      font-size: 16px;
      font-family: verdana,helvetica,arial,sans-serif;
    }
    table {
      background:#CCC;border:1px solid #000;margin-bottom:5px;
    }
    table td, th {
      padding-left:10px;padding-right:10px;border:1px solid #DDD;
    }
  </style>
  <script>
    chartDatetimeFormatter   = d3.time.format("%yyyy.%m.%d - %H:%M"); //see https://github.com/mbostock/d3/wiki/Time-Formatting
    tableDatetimeFormatter   = d3.time.format("%yyyy.%m.%d - %H:%M:%S"); //see https://github.com/mbostock/d3/wiki/Time-Formatting

    soapServiceHistDataUrl   = document.location+ "historical-sensordata/";
    soapServiceLatestDataUrl = document.location+"latest-sensordata/";
  </script>
  <script>
    $(function() {
      $("#fromdate").datepicker({
        changeMonth: true,
        onClose: function(selectedDate) {
          $("#todate").datepicker("option", "minDate", selectedDate);
        }
      });
      $("#todate").datepicker({
        changeMonth: true,
        onClose: function( selectedDate ) {
          $("#fromdate").datepicker("option", "maxDate", selectedDate);
        }
      });
    });
  </script>
  <script>
    $(function() {
      $("#refresh_historical_btn")
        .button()
        .click(function(event) {
          getHistoricalSensordata();
        });
    });
    $(function() {
      $("#refresh_latest_btn")
        .button()
        .click(function(event) {
          getLatestSensordata();
        });
    });
  
    function getHistoricalSensordata() {
      var fromDate   = $("#fromdate").val();
      var fromTs     = fromDate == "" ? "" : Date.parse(fromDate);
      var toDate     = $("#todate").val();
      var oneDayInMs = new Date(1970, 0, 2) - new Date(1970, 0, 1);
      var toTs       = toDate == "" ? "" : Date.parse(toDate) + oneDayInMs - 1; //increase to end of day
      $.ajax({
        url: soapServiceHistDataUrl + "?fromtimestamp=" + fromTs + "&totimestamp=" + toTs
      }).then(function(data) {
        var chartData = [];
        data.forEach(function(elem) {
          var color = elem.sensorKind == 'temperature' ? '#A4C4E8' : elem.sensorKind == 'humidity' ? '#FCDAB0' : '#336600';
          chartData.push({key: (elem.sensorKind +" " +elem.sensorName), area: true, color: color, values: elem.values});
        });
        drawChart(chartData);
      });
    }

    function getLatestSensordata() {
      $.ajax({
        url: soapServiceLatestDataUrl
      }).then(function(data) {
        $('#dynamictable').empty();
        $('#dynamictable').append('<table></table>');
        var table = $('#dynamictable').children();
        table.append("<tr><th>Sensor Kind</th><th>Sensor Name</th><th>Value Time</th><th>Value</th></tr>");
        data.forEach(function(elem) {
          table.append("<tr><td>" + elem.sensorKind + "</td><td>" + elem.sensorName + "</td><td>" + tableDatetimeFormatter(new Date(elem.values[0].x)) + "</td><td>" + elem.values[0].y.toFixed(1) + "</td></tr>");
        });
      });
    }

    function drawChart(tempHumidData) {
      nv.addGraph(function() {
      var chart = nv.models.linePlusBarChart()
        .margin({top: 30, right: 60, bottom: 50, left: 70})
        .x(function(d,i) { return i })
        .y(function(d) { return d[1] })
        .color(d3.scale.category10().range())
        ;

      chart.xAxis
        .showMaxMin(false)
        .tickFormat(function(d) {
          var dx = data[0].values[d] && data[0].values[d][0] || 0;
          return d3.time.format('%x')(new Date(dx))
        });

      chart.y1Axis
        .tickFormat(d3.format(',f'));

      chart.y2Axis
        .tickFormat(function(d) { return '$' + d3.format(',f')(d) });

      chart.bars.forceY([0]);

      d3.select('#chart svg')
        .datum(tempHumidData)
        .transition().duration(500)
        .call(chart)
        ;

      nv.utils.windowResize(chart.update);

      return chart;
      });      
    }
  </script>
</head>
<body>
<h1>Raspberry Pi Home Weather Chart</h1>

<div id='chart'>
  <svg style='height:500px'></svg>
</div>

<script>
  getHistoricalSensordata();
  getLatestSensordata();
</script>

<div class="ui-widget">
  <label for="fromdate">From</label>
  <input type="text" id="fromdate" name="fromdate">
  <label for="todate">To</label>
  <input type="text" id="todate" name="fromdate">
  <button id="refresh_historical_btn">Refresh Chart</button>
</div>

<br />
<div class="ui-widget">
  <div id="dynamictable"></div>
  <button id="refresh_latest_btn">Refresh Latest Values</button>
</div>

</body>
</html>


